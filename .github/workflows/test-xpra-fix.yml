name: Run MC with Xvfb customizable
on:
  workflow_dispatch:
    inputs:
      mc:
        description: 'The MC version to build'
        required: true
        default: '1.12.2'
      mc-runtime-test:
        description: 'The MC-Runtime-Test version to use'
        required: true
        default: 'lexforge'
      modloader:
        description: 'The modloader to install with HeadlessMc (forge, neoforge or fabric)'
        required: true
        default: 'forge'
      regex:
        description: 'Regex to match the MC version to launch (forge is like 1.20.4-forge and fabric starts with fabric-1.20)'
        required: true
        default: '.*forge.*'
      java:
        description: 'The Java version to use'
        required: true
        default: '8'
      java-distribution:
        description: 'The Java distribution to use'
        required: false
        default: 'adopt'
      headlessmc-command:
        description: 'Arguments for the headlessmc command.'
        required: false
        default: '--jvm -Djava.awt.headless=true'
        type: string
      hmc-version:
        description: 'The version of headlessmc to download.'
        required: false
        default: '2.3.1'
        type: string
      xvfbcommand:
        description: 'Additional args for the xvfb-run command'
        required: false
        default: ''
        type: string

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ github.event.inputs.java }}
          distribution: ${{ github.event.inputs.java-distribution }}
      - name: Setup HeadlessMC directory
        run: mkdir HeadlessMC
      - name: Configure HeadlessMC java versions
        run: echo hmc.java.versions=$JAVA_HOME/bin/java > HeadlessMC/config.properties
      - name: Configure HeadlessMC game directory
        run: echo hmc.gamedir=$PWD/run >> HeadlessMC/config.properties
      - name: Configure offline mode
        run: echo hmc.offline=true >> HeadlessMC/config.properties
      - name: Configure Exceptions
        run: echo hmc.rethrow.launch.exceptions=true >> HeadlessMC/config.properties
      - name: Configure Failing on wrong command
        run: echo hmc.exit.on.failed.command=true >> HeadlessMC/config.properties
      - name: Configure Dummy Assets
        run: echo hmc.assets.dummy=true >> HeadlessMC/config.properties
      - name: Get HeadlessMC
        run: wget -O headlessmc-launcher.jar https://github.com/3arthqu4ke/headlessmc/releases/download/${{ github.event.inputs.hmc-version }}/headlessmc-launcher-${{ github.event.inputs.hmc-version }}.jar
      - name: Download ${{ github.event.inputs.mc }}
        run: java -jar headlessmc-launcher.jar --command download ${{ github.event.inputs.mc }}
      - name: Download ${{ github.event.inputs.modloader }} ${{ github.event.inputs.mc }}
        run: java -jar headlessmc-launcher.jar --command ${{ github.event.inputs.modloader }} ${{ github.event.inputs.mc }} --java ${{ github.event.inputs.java }}
      - name: List versions
        run: java -jar headlessmc-launcher.jar --command versions
      - name: Make mods dir
        run: mkdir -p run/mods
      - name: Configure Accessibility
        run: echo onboardAccessibility:false >> run/options.txt
      - name: Download mc-runtime-test jar ${{ inputs.mc-runtime-test }}
        run: wget -O run/mods/mc-runtime-test-${{ github.event.inputs.mc }}-2.4.1-${{ github.event.inputs.mc-runtime-test }}-release.jar https://github.com/3arthqu4ke/mc-runtime-test/releases/download/2.4.1/mc-runtime-test-${{ github.event.inputs.mc }}-2.4.1-${{ github.event.inputs.mc-runtime-test }}-release.jar
      - name: Install xpra
        run: sudo apt-get install xpra
      - name: Start xpra
        run: xpra start :100
      - name: Export xpra
        run: export DISPLAY=:100
      - name: Run game with xpra
        run: ${{ github.event.inputs.xvfbcommand }}java -Dhmc.check.xvfb=true -jar headlessmc-launcher.jar --command launch ${{ github.event.inputs.regex }} -regex ${{ github.event.inputs.headlessmc-command }}
        shell: bash
